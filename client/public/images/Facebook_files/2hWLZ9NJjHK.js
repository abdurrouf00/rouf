;/*FB_PKG_DELIM*/

__d("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="24417890567818094"}),null);
__d("EBMessageRangeQueryWithPersistenceQuery.graphql",["EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"app_id"},c={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},d={defaultValue:null,kind:"LocalArgument",name:"restore_type"},e=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],f={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},j={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},k={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},l=[g,h];return{fragment:{argumentDefinitions:[a,c,d],kind:"Fragment",metadata:null,name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{args:null,kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,d,a],kind:"Operation",name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},f,g,h,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[i,f,g,h,j,k],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[i,f,g,h,j,k,{alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:b("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"),metadata:{},name:"EBMessageRangeQueryWithPersistenceQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBMessageRangeQueryWithPersistence",["Base64Utils","EBAPIDecryptionModule","EBAPIQPLPoints","EBAPISharedUtils","EBAPIWorkerCheck","EBDeriveAndStoreEpochs","EBMessageRangeQueryUtils","EBMessageRangeQueryWithPersistenceQuery.graphql","I64","LSDatabaseSingleton","LSDecryptMessageProtobufsStoredProcedure","LSDecryptMessagesStoredProcedure","LSEncryptedBackupsMessagesRangeQueryDirection","LSFactory","LSIntEnum","LSMEBTaskCreationSource","LSShape","LSVec","MAWCurrentUser","MAWEBRestoreTrackingUtils","MAWJids","MAWJobDefinitions","MAWMiActGetThreadLifecycleState","MAWMiActThreadLifecycleState","QPLFlow","WAHashStringToNumber","WAJids","WAResultOrError","WATagsLogger","WorkerRelay","WorkerRelayNetwork","getErrorSafe","gkx","handleRestoreMessagesGraphQLResponse","justknobx","promiseDone","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=c("requireDeferred")("LSEBUnifiedRestoreUtils").__setRef("EBMessageRangeQueryWithPersistence"),F=c("requireDeferred")("LSRestoreEchoBlobs.nop").__setRef("EBMessageRangeQueryWithPersistence"),G=c("requireDeferred")("LSRestoreProtobufs.nop").__setRef("EBMessageRangeQueryWithPersistence"),H=d("WATagsLogger").TAGS(["labyrinth_web","EBMessageRangeQueryWithPersistence"]),I=h!==void 0?h:h=b("EBMessageRangeQueryWithPersistenceQuery.graphql");async function a(a){var b=a.chatJid,e=a.direction,g=a.includeOffset;g=g===void 0?!1:g;var h=a.numMessages,p=a.sortOrderMs,q=a.source,r=a.traceId;if(d("EBAPIWorkerCheck").runningInWorker())return d("WAResultOrError").makeError("unsupported-context");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql");var s=d("WAHashStringToNumber").hashStringToNumber(r),t=c("qpl")._(521471755,"2586"),u=d("QPLFlow").startQPLFlow(t,{annotations:{bool:{mainThreadRestore:!0,workerThreadRestore:!1},int:{num_messages_requested:h,source:q!=null?q:c("LSMEBTaskCreationSource").UNKNOWN},string:{request_args:JSON.stringify(a)}},instanceKey:s,timeoutInMs:c("justknobx")._("2950")});try{H.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[","] Issuing messageRangeQuery with args: ",""])),r,JSON.stringify(a));d("MAWEBRestoreTrackingUtils").markEBRestorePaginated(q,r,"GQL_MAIN_THREAD");var v=await (B||(B=d("LSDatabaseSingleton"))).getLSDatabaseSingletonPromiseOrValue(),w;await v.runInTransaction(async function(a){var c;u.addPoint("get_client_state_start");w=await d("handleRestoreMessagesGraphQLResponse").getClientState(v,a);d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{device_id:(C||(C=d("I64"))).to_string((c=(c=w)==null?void 0:c.device_id)!=null?c:(C||(C=d("I64"))).zero)}},pointName:"client_state_retrieved",traceId:r});u.addPoint("get_client_state_end",{string:{device_id:C.to_string((c=(c=w)==null?void 0:c.device_id)!=null?c:(C||(C=d("I64"))).zero)}});c=await d("MAWMiActGetThreadLifecycleState").getThreadLifecycleStateByJid(a,d("MAWJids").convertChatJidToIntJid(b),"GQL_range_restore_eb_api_call");if(c.type===d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MAPPING_ROW||c.type===d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MI_THREAD){d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:c.type}},pointName:"chat_jid_not_found_in_act_mapping_table",traceId:r});u.addPoint("chat_jid_not_found_in_act_mapping_table");d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(r,!1);u.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.thread.missing.error");return d("WAResultOrError").makeError("thread-not-found-in-mi-act-mapping-table")}else d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:c.type}},pointName:"chat_jid_exists_in_act_mapping_table",traceId:r}),u.addPoint("chat_jid_exists_in_act_mapping_table")},"readwrite",void 0,void 0,f.id+":192");if(w==null){H.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["No client state found - unable to restore"])));u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("no-client-state")}t=w;s=t.backupId;a=t.device_id;var x=t.locally_available_epochs,y=t.mailboxRootKey;t=t.ocmfClientStateBlob;if(s==null||a==null||y==null||t==null){H.ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["mandatory params of client state are null"])));u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,"client_state_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-client-state")}var z=d("MAWCurrentUser").getAppID();d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"app_id_retrieved",traceId:r});u.addPoint("app_id_retrieved");var A=d("WAJids").threadIdForChatJid(b);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"converted_chatjid_to_threadid",traceId:r});u.addPoint("converted_chatjid_to_threadid");e=e==="before"?c("LSEncryptedBackupsMessagesRangeQueryDirection").BEFORE:c("LSEncryptedBackupsMessagesRangeQueryDirection").AFTER;x={restore_context:{act_thread_id:d("MAWJobDefinitions").toThreadJidPrimaryId(A),site:"www",tam_thread_subtype:0},success:babelHelpers.extends({device_context:{device_id:(C||(C=d("I64"))).to_string(a),locally_available_epochs:x,raw_tokens:{mailbox_root_key:d("Base64Utils").fromArrayBuffer(y),ocmf_client_state_blob:d("Base64Utils").fromArrayBuffer(t)}},direction:e,include_offset:g,query_num_messages:h,server_thread_key:A},p!=null?{reference_timestamp:d("EBMessageRangeQueryUtils").safeTimestampMsString(p)}:{})};u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_start",traceId:r});var D;try{await d("WorkerRelayNetwork").createWorkerNetworkExecute(),D=await d("WorkerRelay").createWorkerQuery(I,{app_id:String(z!=null?z:"0"),restore_payload_string:JSON.stringify(x),restore_type:"RANGE_QUERY_RESTORE"}),u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_end",traceId:r})}catch(a){y=c("getErrorSafe")(a);u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,errorStackTrace:y.stack}});return d("WAResultOrError").makeError("invalid-graphql-response")}if(D==null||((t=D)==null||(t=t.viewer)==null||(t=t.encrypted_backup)==null?void 0:t.mailbox)==null){u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}g=(e=D)==null||(e=e.viewer)==null||(e=e.encrypted_backup)==null||(e=e.mailbox)==null?void 0:e.messages;if(g==null){H.ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["GQL worker range restore query returned null for message response"])));u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}h=g;if((h==null?void 0:h.encrypted_messages)==null){u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,"null_messages");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}A=h.backup_id;z=h.encrypted_messages;x=h.epoch_derivation_set;y=h.exception_string;t=h.message_range_info;e=h.should_delete_mailbox;g=h.thread_not_found;u.addAnnotations({bool:{should_delete_mailbox:e!=null?e:!1},int:{response_messages:z.length},string:{message_range_info:JSON.stringify(t)}});if(y!=null){H.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["server side exception during graphql restore - ",""])),y);if(g!=null&&g){u.addPoint("thread_not_found_on_server");d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"thread_not_found_on_server",traceId:r});u.endSuccess();d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(r,!1);return d("WAResultOrError").makeError("thread-not-found-on-server")}e===!0&&(u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"delete_mailbox",traceId:r}));u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:y}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{exception:y}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("server-side-exception")}u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START);c("gkx")("7473")?await d("EBDeriveAndStoreEpochs").deriveAndStoreEpochsNonLS(v,x):await d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(x,v,a,r);u.addAnnotations({bool:{hasEpochs:x!=null&&x.epoch_edges.length>0,nonLS:c("gkx")("7473")}});u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END);A==null&&(H.WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["backup_id is null during graphQL restore"]))),u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"backup_id_null",traceId:r}));h=await J(v,b,z,A!=null?A:(C||(C=d("I64"))).to_string(s),t,r,u);if(h.success===!1)return h;K(v,b,h.value,p,q,r);return d("WAResultOrError").makeResult()}catch(a){g=c("getErrorSafe")(a);H.ERROR(o||(o=babelHelpers.taggedTemplateLiteralLoose(["graphQL range restore error ",""])),g);u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,errorStackTrace:(e=g.stack)!=null?e:""}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").DEPRECATED_makeError("runtime-error",g)}}async function J(a,b,e,g,h,i,j){var k=d("WAJids").threadIdForChatJid(b),l=d("WAHashStringToNumber").hashStringToNumber(i),m=c("qpl")._(521471755,"2586");e.length===0&&(H.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["No messages to restore"]))),j.addAnnotations({bool:{hasMessagesToRestore:!1}}),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"no_messages",traceId:i}));if(h==null){H.ERROR(q||(q=babelHelpers.taggedTemplateLiteralLoose(["message range info is null - cannot proceed with graphQL restore"])));j.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}var n=h.has_more_after,o=h.has_more_before,B=h.next_message_timestamp_ms_after;h=h.next_message_timestamp_ms_before;if(o==null||n==null||B==null||h==null){H.ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["message range info is not complete - cannot proceed with graphQL restore"])));j.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"message_range_info_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}if(e.length===0){j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_MESSAGES_TO_RESTORE);j.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.success");return d("WAResultOrError").makeResult({echo:[],messageRangeInfo:{has_more_after:n,has_more_before:o,next_message_timestamp_ms_after:B,next_message_timestamp_ms_before:h},protobuf:[]})}g=d("handleRestoreMessagesGraphQLResponse").processMessageArray(e,g,m,l);var C=g.encryptedLSEchoMessages,D=g.encryptedMessagesWithProtobufs;m=g.encryptedNonLSEchoMessages;l=g.encryptedNonLSProtobufs;j.addAnnotations({bool:{hasEchoMessages:C.length>0,hasProtobufMessages:D.length>0}});if(c("gkx")("7473")){j.addPoint("native_decryption_start");g=d("WAJids").threadIdForChatJid(b);b=await d("EBAPIDecryptionModule").decryptUsingNativeJS(a,g,l,m);if(!b.success){j.endFail("native_decryption_error",{string:{error_description:"native_decryption_error"}});return d("WAResultOrError").makeError("native-decryption-error")}g=b.value.decryptedEchoMessages;b=b.value.decryptedProtobufs;g=d("EBAPIDecryptionModule").convertNativeDecryptionResponseToDecryptedMessageType(g,b);j.addPoint("native_decryption_success");return d("WAResultOrError").makeResult({echo:c("LSVec").toArray(g.echo),messageRangeInfo:{has_more_after:n,has_more_before:o,next_message_timestamp_ms_after:B,next_message_timestamp_ms_before:h},protobuf:c("LSVec").toArray(g.protobuf)})}e.length!==C.length+D.length&&j.addAnnotations({bool:{hasEchoProtobufCountMismatch:!0}});H.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[","] messageRangeQuery echo: "," protobuf: "," nonLsEcho: "," nonLSProtobuf: ",""])),i,C.length,D.length,m.length,l.length);var E,F;if(C.length>0&&D.length>0){j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RESTORING_MIXED_ECHO_PROTOBUF_PAYLOAD);j.addAnnotations({int:{echoMessagesPayloadSize:C.length,protobufMessagesPayloadSize:D.length,totalRestorePayloadSize:C.length+D.length}});j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_START);b=await a.runInTransaction(async function(a){var b=await c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:k,encryptedMessages:c("LSVec").ofArray(C)}),e=b[0];b=b[1];if(b!=null){var f=d("LSShape").toRecord(b);H.ERROR(t||(t=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with an error."])));H.WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with error: ",""])),f.error_message);j.addAnnotations({string:{echo_decryption_error:f.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"ECHO_DECRYPTION_FAILURE",{string:{error_description:f.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error")}f=await c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:k,encryptedMessagesWithProtobufs:c("LSVec").ofArray(D)});a=f[0];f=f[1];if(f!=null){f=d("LSShape").toRecord(f);H.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with an error."])));H.WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with error: ",""])),f.error_message);j.endFail("PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:f.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:f.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}f=a==null?0:c("LSVec").toArray(a).length;b!=null&&f>0&&j.addAnnotations({bool:{continuedAfterEchoDecryptFailure:!0}});return{decryptedEchoMsgs:e,decryptedProtobufMsgs:a}},"readwrite",void 0,void 0,f.id+":775");g=b.decryptedEchoMsgs;e=b.decryptedProtobufMsgs;j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_END);var G;g!=null&&(G=c("LSVec").toArray(g).map(function(a){return d("LSShape").toRecord(a).value}));E=G;F=e==null?[]:c("LSVec").toArray(e)}else if(D.length===0){j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_START);m=await a.runInTransaction(function(a){return c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:k,encryptedMessages:c("LSVec").ofArray(C)})},"readwrite",void 0,void 0,f.id+":879");l=m[0];b=m[1];if(b!=null){g=d("LSShape").toRecord(b);H.ERROR(x||(x=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with an error."])));H.WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with error: ",""])),g.error_message);j.endFail("ECHO_DECRYPTION_FAILURE",{string:{error_description:g.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"ECHO_DECRYPTION_FAILURE",{string:{error_description:g.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("echo-decryption-failure")}j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_END);if(l!=null){e=c("LSVec").toArray(l).map(function(a){return d("LSShape").toRecord(a).value});E=e}}else{j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_START);m=await a.runInTransaction(function(a){return c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:k,encryptedMessagesWithProtobufs:c("LSVec").ofArray(D)})},"readwrite",void 0,void 0,f.id+":928");b=m[0];g=m[1];if(g!=null){l=d("LSShape").toRecord(g);H.ERROR(z||(z=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with an error"])));H.WARN(A||(A=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with error: ",""])),l.error_message);j.endFail("PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:l.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:l.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_END);F=b==null?[]:c("LSVec").toArray(b)}j.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.success");return d("WAResultOrError").makeResult({echo:E!=null?E:[],messageRangeInfo:{has_more_after:n,has_more_before:o,next_message_timestamp_ms_after:B,next_message_timestamp_ms_before:h},protobuf:F!=null?F:[]})}function K(a,b,e,g,h,i){var j=e.echo,k=e.messageRangeInfo,l=e.protobuf,m=d("WAJids").threadIdForChatJid(b);j.length>0&&l.length>0?c("promiseDone")(E.load().then(function(a){return a.echoProtobufConsolidatedRestoreHelper(m,c("LSVec").ofArray(l),k.has_more_before,(C||(C=d("I64"))).of_string(k.next_message_timestamp_ms_before),k.has_more_after,C.of_string(k.next_message_timestamp_ms_after),!1,i,g,void 0,c("LSVec").ofArray(j),(D||(D=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)})):j.length>0?c("promiseDone")(F.load().then(function(e){return a.runInTransaction(function(a){return e(a,0,(C||(C=d("I64"))).zero,c("LSVec").ofArray(j),k.has_more_before,C.of_string(k.next_message_timestamp_ms_before),k.has_more_after,C.of_string(k.next_message_timestamp_ms_after),!1,m,i,g,(D||(D=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)},"readwrite",void 0,void 0,f.id+":1017")})):c("promiseDone")(G.load().then(function(e){return a.runInTransaction(function(a){return e(a,0,m,c("LSVec").ofArray(l),k.has_more_before,(C||(C=d("I64"))).of_string(k.next_message_timestamp_ms_before),k.has_more_after,C.of_string(k.next_message_timestamp_ms_after),!1,i,g,void 0,c("LSVec").ofArray([]),(D||(D=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)},"readwrite",void 0,void 0,f.id+":1040")}))}g.query=I;g.messageRangeQueryWithPersistence_DEPRECATED_DO_NOT_USE=a}),98);
__d("FBNucleusCautionCircleOutline20Icon.react",["react"],(function(a,b,c,d,e,f,g){"use strict";var h,i=h||d("react");function a(a){return i.jsxs("svg",babelHelpers["extends"]({viewBox:"0 0 20 20",width:"1em",height:"1em",fill:"currentColor"},a,{children:[a.title!=null&&i.jsx("title",{children:a.title}),a.children!=null&&i.jsx("defs",{children:a.children}),i.jsx("path",{d:"M10 4.25a.75.75 0 0 1 .75.75v6a.75.75 0 0 1-1.5 0V5a.75.75 0 0 1 .75-.75zM10 15a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"}),i.jsx("path",{d:"M.5 10a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0zM10 2a8 8 0 1 0 0 16 8 8 0 0 0 0-16z"})]}))}a.displayName=a.name+" [from "+f.id+"]";a._size=20;a._isSVG=!0;b=a;g["default"]=b}),98);
__d("MWRestoreMessagesFromEB",["EBIsEbEnabled","EBMessageRangeQueryWithPersistence","I64","MAWAsyncEBPendingQueryPromise","MAWMainTraceUtils","MWEncryptedBackUpEBNotEnabledError","Promise","WATagsLogger","err","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(a){var e=a.chatJid,f=a.newerNumMessages,g=a.passedTraceId,k=a.sortOrderMs,l=a.source;a=a.storage;if(!c("gkx")("23914"))return null;var m=g!=null?g:d("MAWMainTraceUtils").createTraceId();c("promiseDone")(d("EBIsEbEnabled").isEbEnabledLS(a.tables).then(function(a){if(a)return d("EBMessageRangeQueryWithPersistence").messageRangeQueryWithPersistence_DEPRECATED_DO_NOT_USE({chatJid:e,direction:(j||(j=d("I64"))).to_float(f)>0?"after":"before",includeOffset:c("gkx")("5340"),sortOrderMs:(j||(j=d("I64"))).to_string(k),source:l,traceId:m}).then(function(a){a.success||d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(m,c("err")(a.error))});else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore"]).WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Issuing message range query for chatJid: "," skipped. EB not enabled"])),e);d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(m,c("err")(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED));return(i||(i=b("Promise"))).resolve()}}));return m}g["default"]=a}),98);
__d("MAWEBFetch",["EBFormatUtils","FBLogger","I64","LSMEBTaskCreationSource","MAWAsyncEBPendingQueryPromise","MWEncryptedBackUpEBNotEnabledError","MWRestoreMessagesFromEB","WAResultOrError","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;b=c("justknobx")._("3177");var i=Math.max(3,b-5);async function a(a){var b=a.chatJid,e=a.count,f=a.db,g=a.direction,i=a.timestampMs;a=a.traceId;e=d("EBFormatUtils").adjustCount(e,g);var k=e[0];e=e[1];b=c("MWRestoreMessagesFromEB")({chatJid:b,newerNumMessages:(h||(h=d("I64"))).of_int32(e),numMessages:h.of_int32(k),passedTraceId:a,sortOrderMs:d("EBFormatUtils").adjustTs(i,g),source:c("LSMEBTaskCreationSource").MESSENGER_MESSAGE_LIST_PAGINATION,storage:f});if(b==null)return d("WAResultOrError").makeResult({hasMoreAfter:!1,hasMoreBefore:!1,isEndOfCurrentFormat:!1,messages:[],restoreType:"none"});e=d("MAWAsyncEBPendingQueryPromise").getWaitForRestorePromiseFromTrace(b);k=await e.then(function(a){return d("WAResultOrError").makeResult(a)}).catch(function(a){if(a&&(a==null?void 0:a.message)===d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED)return d("WAResultOrError").makeError(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED);c("FBLogger")("messenger_web").catching(a).mustfix("[EBFetch] Failed to fetch");return d("WAResultOrError").makeError((a=a==null?void 0:a.message)!=null?a:"unknown")});if(k.success===!1)return k;a=k.value;i=a.hasMoreAfter;f=a.hasMoreBefore;b=a.messages;e=a.restoreType;return d("WAResultOrError").makeResult({hasMoreAfter:i,hasMoreBefore:f,isEndOfCurrentFormat:j(g,i,f,b),messages:b,restoreType:e})}function j(a,b,c,d){if(a==="before"&&c===!1)return!1;return a==="after"&&b===!1?!1:d.length<i}g.default=a}),98);